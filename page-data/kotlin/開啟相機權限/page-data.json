{"componentChunkName":"component---src-templates-blog-post-js","path":"/kotlin/開啟相機權限/","result":{"data":{"site":{"siteMetadata":{"title":"Travel in Time.","author":"Zoe Yu"}},"markdownRemark":{"id":"9c27fcd6-615f-544f-ba1c-f7ec21763de9","excerpt":"正式挑戰賽要做物流中心，突然被 Don 要求送貨員是用 QR Code 來登記，花了一些時間弄相機權限和掃描，很菜哈哈！但至少在短時間弄出來了 如何開啟相機權限 首先在 Manifest 設定權限 因為 Android6.0 以上的版本，加強了隱私權設置，因此在操作 APP…","html":"<p>正式挑戰賽要做物流中心，突然被 Don 要求送貨員是用 QR Code 來登記，花了一些時間弄相機權限和掃描，很菜哈哈！但至少在短時間弄出來了</p>\n<p><strong>如何開啟相機權限</strong></p>\n<ol>\n<li>首先在 Manifest 設定權限</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token operator\">&lt;</span><span class=\"token keyword\">uses</span><span class=\"token operator\">-</span>permission android<span class=\"token operator\">:</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"android.permission.CAMERA\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span></code></pre></div>\n<ol start=\"2\">\n<li>因為 Android6.0 以上的版本，加強了隱私權設置，因此在操作 APP 上，就必須讓使用者自行勾選是否開放這些權限</li>\n<li>進入頁面，判斷是否未取得權限，如果沒有就提醒使用者</li>\n<li>了解 <code class=\"language-text\">shouldShowRequestPermissionRationale</code> 用法，可以參考<a href=\"https://blog.csdn.net/cadi2011/article/details/71642355\">這篇</a>\n其屬於 AppCompact 裡，用於權限管理</li>\n</ol>\n<blockquote>\n<p>為了說明查找使用者可能需要解釋的情形，Android 提供了一個實用程式方法，即 shouldShowRequestPermissionRationale()。如果應用之前請求過此許可權但用戶拒絕了請求，此方法將返回 true。</p>\n</blockquote>\n<blockquote>\n<p>注：如果用戶在過去拒絕了許可權請求，並在許可權請求系統對話方塊中選擇了 Don’t ask again 選項，此方法將返回 false。如果設備規範禁止應用具有該許可權，此方法也會返回 false。\n包裝成 function，下次直接拿來用</p>\n</blockquote>\n<ul>\n<li><code class=\"language-text\">requestPermissions</code>用法</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">requestPermissions <span class=\"token punctuation\">(</span>activity<span class=\"token operator\">:</span> <span class=\"token class-name\">Activity</span> <span class=\"token punctuation\">,</span> permissions<span class=\"token operator\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> requestCode<span class=\"token operator\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>根據 requestCode 和 grantResults (授權結果)做相應的後續處理，了解<strong>權限處理</strong>可參考<a href=\"https://www.jianshu.com/p/b4a8b3d4f587\">這篇</a>，附上完整code，以後直接來拿來請求權限吧！</p>\n<p><strong>相機權限</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">fun <span class=\"token function\">cameraPermission</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ContextCompat</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkSelfPermission</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>  <span class=\"token class-name\">Manifest</span><span class=\"token punctuation\">.</span>permission<span class=\"token punctuation\">.</span>CAMERA<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">!=</span> <span class=\"token class-name\">PackageManager</span><span class=\"token punctuation\">.</span>PERMISSION_GRANTED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token comment\">//判斷是否未取得權限(!=)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ActivityCompat</span><span class=\"token punctuation\">.</span><span class=\"token function\">shouldShowRequestPermissionRationale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>activity as <span class=\"token class-name\">HomeActivity</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n        <span class=\"token class-name\">Manifest</span><span class=\"token punctuation\">.</span>permission<span class=\"token punctuation\">.</span>CAMERA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">AlertDialog<span class=\"token punctuation\">.</span>Builder</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">setMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我需要相機，給我權限吧？\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">setPositiveButton</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OK\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> _<span class=\"token punctuation\">,</span> _ <span class=\"token operator\">-></span>\n                    <span class=\"token comment\">//跳出視窗，嘗試向使用者取得權限</span>\n                        <span class=\"token class-name\">ActivityCompat</span><span class=\"token punctuation\">.</span><span class=\"token function\">requestPermissions</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token punctuation\">(</span>activity as <span class=\"token class-name\">HomeActivity</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token function\">arrayOf</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Manifest</span><span class=\"token punctuation\">.</span>permission<span class=\"token punctuation\">.</span>CAMERA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        MY_PERMISSIONS_REQUEST_READ_CONTACTS\n                        <span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">setNegativeButton</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> _<span class=\"token punctuation\">,</span> _ <span class=\"token operator\">-></span>\n                    <span class=\"token punctuation\">(</span>activity as <span class=\"token class-name\">HomeActivity</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">finish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">ActivityCompat</span><span class=\"token punctuation\">.</span><span class=\"token function\">requestPermissions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>activity as <span class=\"token class-name\">HomeActivity</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token function\">arrayOf</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Manifest</span><span class=\"token punctuation\">.</span>permission<span class=\"token punctuation\">.</span>CAMERA<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Manifest</span><span class=\"token punctuation\">.</span>permission<span class=\"token punctuation\">.</span>READ_EXTERNAL_STORAGE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                MY_PERMISSIONS_REQUEST_READ_CONTACTS\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">MissionFragment</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    companion object <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">const</span> val MY_PERMISSIONS_REQUEST_READ_CONTACTS <span class=\"token operator\">=</span> <span class=\"token number\">100</span>\n    <span class=\"token punctuation\">}</span>\n    override fun <span class=\"token function\">onRequestPermissionsResult</span><span class=\"token punctuation\">(</span>requestCode<span class=\"token operator\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span>  \n    permissions<span class=\"token operator\">:</span> <span class=\"token class-name\">Array</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span> grantResults<span class=\"token operator\">:</span> <span class=\"token class-name\">IntArray</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        when <span class=\"token punctuation\">(</span>requestCode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            MY_PERMISSIONS_REQUEST_READ_CONTACTS <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>grantResults<span class=\"token punctuation\">.</span><span class=\"token function\">isNotEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> \n                grantResults<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">PackageManager</span><span class=\"token punctuation\">.</span>PERMISSION_GRANTED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token punctuation\">(</span>activity as <span class=\"token class-name\">HomeActivity</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">finish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">return</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>掃描功能</strong>\n調用 CaptureActivity 就可以實現掃碼功能，如果想進一步調整取景框的樣式，可以參考這篇 <a href=\"https://www.jianshu.com/p/d217c986c060\">Zxing 二維碼掃描和那些坑</a>，有機會實作再來補重點</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">//qr_code: ImageView</span>\nqr_code<span class=\"token punctuation\">.</span>setOnClickListener <span class=\"token punctuation\">{</span>\n    val intent <span class=\"token operator\">=</span> <span class=\"token class-name\">Intent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">CaptureActivity</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">startActivityForResult</span><span class=\"token punctuation\">(</span>intent<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>回傳解析結果</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">override fun <span class=\"token function\">onActivityResult</span><span class=\"token punctuation\">(</span>requestCode<span class=\"token operator\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> resultCode<span class=\"token operator\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">:</span> <span class=\"token class-name\">Intent</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onActivityResult</span><span class=\"token punctuation\">(</span>requestCode<span class=\"token punctuation\">,</span> resultCode<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>requestCode <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//处理扫描结果（在界面上显示）</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span> <span class=\"token operator\">!=</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            val bundle <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">getExtras</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bundle <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bundle<span class=\"token punctuation\">.</span><span class=\"token function\">getInt</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CodeUtils</span><span class=\"token punctuation\">.</span>RESULT_TYPE<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">CodeUtils</span><span class=\"token punctuation\">.</span>RESULT_SUCCESS<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                val result <span class=\"token operator\">=</span> bundle<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CodeUtils</span><span class=\"token punctuation\">.</span>RESULT_STRING<span class=\"token punctuation\">)</span>\n                <span class=\"token class-name\">Toast</span><span class=\"token punctuation\">.</span><span class=\"token function\">makeText</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">,</span> <span class=\"token string\">\"掃描：\"</span> <span class=\"token operator\">+</span> result<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Toast</span><span class=\"token punctuation\">.</span>LENGTH_LONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","tableOfContents":"","frontmatter":{"title":"Android - 掃描 QR Code","date":"Nov 26, 2019","tags":["Kotlin"],"category":"Android","thumbnail":null}}},"pageContext":{"slug":"/kotlin/開啟相機權限/","previous":{"fields":{"slug":"/kotlin/如何接API/"},"frontmatter":{"title":"新手上路，如何接 API 呢？","tags":["Kotlin","API"],"date":"2019-11-11","category":"Android","mark":null,"description":"學習從 Retrofit 2 下手"}},"next":{"fields":{"slug":"/kotlin/實作第三方登入/"},"frontmatter":{"title":"Android - 實作第三方登入","tags":["Kotlin"],"date":"2020-02-11","category":"Android","mark":null,"description":"一次學會 Facebook、Google、Line 登入"}}}},"staticQueryHashes":["63159454"]}